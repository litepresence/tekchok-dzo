<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury of the Supreme Vehicle — 9 Layers</title>
    <meta name="generator" content="Layer Splash Page">
    <style>
    :root {
        --font-main: 'Georgia', 'Times New Roman', serif;
        --font-mono: 'Consolas', 'Courier New', monospace;
        /* Light mode */
        --color-bg: #fafafa;
        --color-bg-secondary: #fff;
        --color-bg-tertiary: #f5f5f5;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-shadow: rgba(0, 0, 0, 0.1);
        --color-nav-bg: #fff;
        --color-nav-border: #ddd;
        --color-toggle-bg: #fff;
        --color-toggle-text: #333;
        --color-toggle-border: #999;
        --color-toggle-hover: #eee;
        /* Layer colors */
        --color-tibetan: #2c5f7f;
        --color-wylie: #5d4037;
        --color-literal: #2e7d32;
        --color-liturgical: #6a1b9a;
        --color-commentary: #f57c00;
        --color-scholar: #00838f;
        --color-epistemic: #ad1457;
        --color-delusion: #c62828;
        --color-cognitive: #455a64;
        --color-glossary: #77d3ff;
        --color-contents: #37474f;
    }

    /* Dark mode variable overrides */
    body.dark-mode {
        --color-bg: #1a1a1a;
        --color-bg-secondary: #2d2d2d;
        --color-bg-tertiary: #3a3a3a;
        --color-text: #f0f0f0;
        --color-muted: #aaa;
        --color-border: #444;
        --color-shadow: rgba(0, 0, 0, 0.4);
        --color-nav-bg: #1e1e1e;
        --color-nav-border: #444;
        --color-toggle-bg: #333;
        --color-toggle-text: #fff;
        --color-toggle-border: #666;
        --color-toggle-hover: #444;
    }

    * {
        box-sizing: border-box;
    }

    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-main);
        color: var(--color-text);
        line-height: 1.6;
        background: var(--color-bg);
        transition: background-color 0.3s ease, color 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    /* Navigation */
    .nav-container {
        position: sticky;
        top: 0;
        background: var(--color-nav-bg);
        border-bottom: 2px solid var(--color-nav-border);
        z-index: 1000;
        padding: 0.5em 1em;
        box-shadow: 0 2px 4px var(--color-shadow);
        transition: background-color 0.3s ease, border-color 0.3s ease;
        flex-shrink: 0;
    }

    .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25em;
        justify-content: center;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    .nav-divider {
        width: 1px;
        height: 24px;
        background: var(--color-border);
        margin: 0 0.5em;
    }

    .dark-mode-toggle {
        margin-left: auto;
        padding: 0.4em 0.8em;
        border: 1px solid var(--color-toggle-border);
        border-radius: 4px;
        background: var(--color-toggle-bg);
        color: var(--color-toggle-text);
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dark-mode-toggle:hover {
        background: var(--color-toggle-hover);
    }

    .nav-tab {
        padding: 0.5em 1em 0.5em 1.8em;
        border: none;
        border-radius: 999px;
        font-family: var(--font-main);
        font-size: 0.85em;
        cursor: pointer;
        text-decoration: none;
        color: #fff;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
    }

    .nav-tab::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border: 2px solid rgba(255,255,255,0.5);
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .nav-tab:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .nav-tab.active::before {
        background: #fff;
        border-color: #fff;
    }

    .nav-tab.active {
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(255,255,255,0.4);
        font-weight: bold;
    }

    .nav-tab.introduction {
        background: var(--color-tibetan);
    }

    .nav-tab.introduction.active {
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(255,255,255,0.4);
        font-weight: bold;
    }

    .nav-tab.contents {
        background: var(--color-contents);
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.contents::before {
        display: none;
    }

    .nav-tab.contents.active {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .nav-tab.conventions {
        background: #6d4c41;
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.conventions::before {
        display: none;
    }

    .nav-tab.conventions:hover {
        background: #8d6e63;
    }

    .layer-dropdown {
        background: var(--color-tibetan);
        color: var(--color-text);
        border: none;
        border-radius: 4px;
        padding: 0.4em 0.8em;
        font-family: var(--font-sans);
        font-size: 0.85em;
        cursor: pointer;
        outline: none;
    }

    .layer-dropdown:hover {
        background: var(--color-tibetan-hover, #3d6a8b);
    }

    .layer-dropdown:focus {
        box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }

    .layer-dropdown option {
        background: var(--color-bg);
        color: var(--color-text);
    }

    .chapter-dropdown {
        background: var(--color-contents);
        color: var(--color-text);
        border: none;
        border-radius: 4px;
        padding: 0.4em 0.8em;
        font-family: var(--font-sans);
        font-size: 0.85em;
        cursor: pointer;
        outline: none;
    }

    .chapter-dropdown:hover {
        background: #4a5a68;
    }

    .chapter-dropdown:focus {
        box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }

    .chapter-dropdown option {
        background: var(--color-bg);
        color: var(--color-text);
    }

    .toolbar-nav-btn {
        background: var(--color-contents);
        color: var(--color-text);
        border: none;
        border-radius: 4px;
        padding: 0.2em 0.5em;
        font-family: var(--font-sans);
        font-size: 0.85em;
        cursor: pointer;
        outline: none;
        line-height: 1;
    }

    .toolbar-nav-btn:hover {
        background: #4a5a68;
    }

    .toolbar-nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .nav-tab.tibetan {
        background: var(--color-tibetan);
    }

    .nav-tab.wylie {
        background: var(--color-wylie);
    }

    .nav-tab.literal {
        background: var(--color-literal);
    }

    .nav-tab.liturgical {
        background: var(--color-liturgical);
    }

    .nav-tab.commentary {
        background: var(--color-commentary);
    }

    .nav-tab.scholar {
        background: var(--color-scholar);
    }

    .nav-tab.epistemic {
        background: var(--color-epistemic);
    }

    .nav-tab.delusion {
        background: var(--color-delusion);
    }

    .nav-tab.cognitive {
        background: var(--color-cognitive);
    }

    .nav-tab.glossary {
        background: var(--color-glossary);
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.glossary::before {
        display: none;
    }

        .nav-tab.glossary.active {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Content layers */
    .content-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
    }

    .layer-content {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
    }

    .layer-content.active {
        display: flex;
    }

    .layer-header {
        padding: 0.5em 1.5em;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg-secondary);
        display: flex;
        align-items: center;
        gap: 1em;
    }

    .layer-header .header-title {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--color-text);
    }

    .layer-header .header-info {
        color: var(--color-muted);
        font-size: 0.85em;
    }

    .layer-header .header-indicator {
        margin-left: auto;
        color: var(--color-tibetan);
        font-size: 0.9em;
        font-weight: 500;
    }

    .iframe-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
        min-height: 0;
    }

    .layer-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: var(--color-bg);
        min-height: 100%;
    }

    /* Line indicator */
    .line-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 0.75em 1em;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 0.85em;
        z-index: 1001;
        display: none;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .line-indicator.visible {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Consent Modal */
    .consent-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 2em;
    }

    .consent-modal.hidden {
        display: none;
    }

    .consent-content {
        max-width: 900px;
        text-align: center;
        padding: 0 1em;
    }

    .consent-header {
        margin-bottom: 1.5em;
    }

    .consent-header .main-title {
        font-size: 1.1em;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5em;
    }

    .consent-header .title {
        font-size: 2.2em;
        color: var(--color-tibetan);
        margin: 0.3em 0;
        font-weight: normal;
    }

    .consent-header .author {
        font-size: 1.1em;
        color: var(--color-muted);
        font-style: italic;
        margin-bottom: 0.5em;
    }

    .consent-header .subtitle {
        font-size: 1.1em;
        color: var(--color-text);
    }

    .consent-divider {
        width: 60%;
        height: 1px;
        background: var(--color-border);
        margin: 1.5em auto;
    }

    .consent-description {
        text-align: justify;
        line-height: 1.8;
        color: var(--color-text);
        font-size: 0.95em;
        margin-bottom: 1.5em;
    }

    .consent-disclaimer {
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1.5em;
        margin: 1.5em 0;
        text-align: left;
    }

    .consent-disclaimer ol {
        margin: 0;
        padding-left: 1.5em;
    }

    .consent-disclaimer li {
        margin-bottom: 0.5em;
        line-height: 1.5;
    }

    .consent-agree-btn {
        display: inline-block;
        background: var(--color-tibetan);
        color: #fff;
        border: none;
        padding: 1em 2.5em;
        font-size: 1em;
        font-family: var(--font-main);
        cursor: pointer;
        border-radius: 4px;
        margin-top: 1.5em;
        transition: all 0.2s ease;
    }

    .consent-agree-btn:hover {
        background: #3a7a9f;
        transform: translateY(-1px);
    }

    .consent-footer {
        margin-top: 2em;
        color: var(--color-muted);
        font-size: 0.85em;
    }

    .consent-footer .license {
        margin-bottom: 0.5em;
    }

    .consent-footer .verse {
        font-style: italic;
        margin: 1em 0;
        line-height: 1.6;
    }

    .consent-footer .translator {
        margin-top: 1em;
    }

    .consent-footer .report {
        margin-top: 1em;
        font-size: 0.8em;
    }

    .consent-footer a {
        color: var(--color-tibetan);
        text-decoration: none;
    }

    .consent-footer a:hover {
        text-decoration: underline;
    }

    /* Image Consent Modal */
    .consent-image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 2em;
    }

    .consent-image-modal.hidden {
        display: none;
    }

    .consent-image-content {
        max-width: 900px;
        text-align: center;
        padding: 0 1em;
    }

    .consent-image-content img {
        max-width: 100%;
        max-height: 60vh;
        object-fit: contain;
        border-radius: 8px;
        margin-bottom: 1.5em;
        box-shadow: 0 4px 20px var(--color-shadow);
    }

    .consent-image-content .image-caption {
        color: var(--color-muted);
        font-style: italic;
        margin-bottom: 1em;
        font-size: 0.9em;
    }

    .consent-image-content .confirm-text {
        color: var(--color-text);
        font-size: 1.1em;
        margin-bottom: 1em;
    }

    /* Welcome screen */
    .welcome-screen {
        text-align: center;
        padding: 4em 2em;
        background: var(--color-bg-secondary);
        flex: 1;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease;
    }

    .welcome-screen h1 {
        font-size: 2.5em;
        color: var(--color-tibetan);
        margin-bottom: 0.5em;
    }

    .welcome-screen .subtitle {
        font-size: 1.2em;
        color: var(--color-muted);
        margin-bottom: 2em;
    }

    .welcome-screen .description {
        max-width: 600px;
        margin: 0 auto;
        text-align: left;
        color: var(--color-text);
    }

    .welcome-screen .description p {
        margin-bottom: 1em;
    }

    @media (max-width: 768px) {
        .consent-modal,
        .consent-image-modal {
            padding: 1em;
        }

        .consent-header .main-title {
            font-size: 0.9em;
        }

        .consent-header .title {
            font-size: 1.6em;
        }

        .consent-header .author,
        .consent-header .subtitle {
            font-size: 1em;
        }

        .consent-description {
            font-size: 0.9em;
            text-align: left;
        }

        .consent-disclaimer {
            padding: 1em;
        }

        .consent-disclaimer li {
            font-size: 0.85em;
        }

        .consent-agree-btn {
            padding: 0.8em 1.5em;
            font-size: 0.9em;
        }

        .consent-footer {
            font-size: 0.8em;
        }

        .consent-footer .verse {
            font-size: 0.9em;
        }

        .consent-image-content img {
            max-height: 50vh;
        }

        .consent-image-content .confirm-text {
            font-size: 1em;
        }

        .nav-tabs {
            gap: 0.15em;
        }

        .nav-tab {
            padding: 0.4em 0.6em 0.4em 1.4em;
            font-size: 0.75em;
        }

        .nav-tab::before {
            left: 6px;
            width: 6px;
            height: 6px;
        }

        .nav-tab.introduction {
            padding: 0.4em 0.6em 0.4em 1.4em;
            font-size: 0.75em;
        }

        .nav-tab.introduction::before {
            left: 6px;
            width: 6px;
            height: 6px;
        }

        .nav-tab.contents {
            padding: 0.4em 0.6em;
        }

        .nav-divider {
            height: 18px;
            margin: 0 0.25em;
        }
    }
    </style>
</head>

<body>
    <!-- Consent Modal -->
    <div id="consent-modal" class="consent-modal">
        <div class="consent-content">
            <div class="consent-header">
                <div class="main-title">The first complete English translation of</div>
                <h1 class="title">TEKCHOK DZO</h1>
                <div class="author">Longchenpa Rabjam's</div>
                <div class="subtitle">Jewel Treasury of the Supreme Vehicle</div>
                <div class="subtitle">herein abides:</div>
            </div>
            
            <div class="consent-divider"></div>
            
            <div class="consent-description">
                This text is best described as "lineage-restricted esoteric instruction" within the Atiyoga vehicle. It belongs to the Dzogchen "Menngagde" or Instruction Series. This classification indicates it is reserved for initiated students. It requires empowerment and oral transmission from a qualified master. The content covers direct introduction to rigpa. It includes practices like Trekcho and Thogal. These involve the light body and dissolution of elements. In traditional contexts this material is confidential. It is not intended for general intellectual study. The restriction protects the integrity of the practice. It ensures the student has the necessary preparation. Describing it as "empowerment-dependent non-dual instruction" is also accurate. This distinguishes it from exoteric sutra teachings. It aligns with the Nyingma nine-vehicle system where Atiyoga is supreme.
            </div>
            
            <div class="consent-description">
                This translation was produced in a largely autonomous manner utilizing Kimi K2.5 and the agentic framework OpenCode. The final draft was reviewed and revised by additional models including Qwen 3.5, Grok Expert, GPT5, and GLM5.
            </div>
            
            <div class="consent-disclaimer">
                <ol>
                    <li>This is a Restricted Dzogchen text; please consult your lama.</li>
                    <li>This is an unauthorized translation which arose from personal practice.</li>
                    <li>This translation was produced using ~300 hours of AI.</li>
                    <li>The translator does not speak or read Tibetan.</li>
                    <li>This translation may still have significant metaphysical flaws.</li>
                    <li>This website is still under construction.</li>
                    <li>The translator has not read the complete text at this time.</li>
                    <li>The literal translation is 1,500 pages. The liturgical translation is 1,500 pages.</li>
                    <li>The website includes an additional 7,500 pages of AI-generated commentary NOT found in the root text.</li>
                </ol>
            </div>
            
            <button class="consent-agree-btn" onclick="acceptConsent()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
            
            <div class="consent-footer">
                <div class="license">License: Copyleft</div>
                <div>February 20, 2026 (Losar)</div>
                <div class="verse">
                    As the light of presence spontaneously shines forth,<br>
                    ultimately not a single thing has arisen:<br>
                    Ownership finds no ground.
                </div>
                <div class="translator">litepresence — radical dzogchen practitioner and emergent systems engineer</div>
                <div class="report">
                    Report issues at <a href="https://github.com/litepresence/tekchok-dzo" target="_blank">github.com/litepresence/tekchok-dzo</a>.<br>
                    Complete git revision history and prompt engineering are available for review.
                </div>
            </div>
        </div>
    </div>

    <!-- Image Consent Modal 1 -->
    <div id="consent-image-1" class="consent-image-modal hidden">
        <div class="consent-image-content">
            <img src="../images/Longchenpa_line_drawing.jpg" alt="Longchenpa">
            <div class="image-caption">Longchenpa Rabjam (ཀློང་ཆེན་རབ་འབྱམས་པ)</div>
            <div class="confirm-text">Do you confirm your intention to receive this restricted teaching?</div>
            <button class="consent-agree-btn" onclick="acceptImageConsent1()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
        </div>
    </div>

    <!-- Image Consent Modal 2 -->
    <div id="consent-image-2" class="consent-image-modal hidden">
        <div class="consent-image-content">
            <img src="../images/Longchenpa_Nyingthig_Lineage.jpg" alt="Nyingthig Lineage">
            <div class="image-caption">Nyingthig Lineage Masters</div>
            <div class="confirm-text">Do you make this request with pure motivation and proper respect for the lineage?</div>
            <button class="consent-agree-btn" onclick="acceptImageConsent2()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <a href="#contents" class="nav-tab contents">Contents</a>
            <a href="#conventions" class="nav-tab conventions">Conventions</a>
            <span class="nav-divider"></span>
            <select id="layer-select" class="layer-dropdown" onchange="handleLayerSelect(this.value)">
                <option value="#introduction">Introduction</option>
                <option value="#tibetan">Tibetan</option>
                <option value="#wylie">Wylie</option>
                <option value="#literal">Literal</option>
                <option value="#liturgical" selected>Liturgical</option>
                <option value="#commentary">Commentary</option>
                <option value="#scholar">Scholar</option>
                <option value="#epistemic">Epistemic</option>
                <option value="#delusion">Delusion</option>
                <option value="#cognitive">Cognitive</option>
            </select>
            <button class="toolbar-nav-btn" onclick="handlePrev()" title="Previous">&lt;</button>
            <button class="toolbar-nav-btn" onclick="handleNext()" title="Next">&gt;</button>
            <select id="chapter-select" class="chapter-dropdown" onchange="handleChapterSelect(this.value)">
                <option value="">Select Chapter...</option>
            </select>
            <span class="nav-divider"></span>
            <a href="#glossary" class="nav-tab glossary">Glossary</a>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">Dark</button>
        </div>
    </nav>
    <!-- Welcome Screen -->
    <div id="welcome" class="welcome-screen">
        <h1>Treasury of the Supreme Vehicle</h1>
        <div class="subtitle">ཐེག་པའི་མཆོག་རིན་པོ་ཆེའི་མཛོད</div>
        <div class="description">
            <p>Welcome to the nine-layer translation of Longchen Rabjampa's masterpiece.
                This interface provides access to parallel views of the text across multiple
                interpretive layers.</p>
            <p><strong>Click any tab above</strong> to explore that layer. When viewing
                Tibetan and Wylie layers, switching between them preserves your scroll
                position by line number. For later layers (Commentary through Cognitive),
                the system finds the nearest matching line range.</p>
            <p>Each layer represents a different aspect of the translation:</p>
            <ul>
                <li><strong>Tibetan</strong> — Original Tibetan text</li>
                <li><strong>Wylie</strong> — Tibetan transliteration</li>
                <li><strong>Literal</strong> — Word-by-word translation</li>
                <li><strong>Liturgical</strong> — Poetic chanting version</li>
                <li><strong>Commentary</strong> — Philosophical interpretation</li>
                <li><strong>Scholar</strong> — Academic analysis</li>
                <li><strong>Epistemic</strong> — View/pedagogy layers</li>
                <li><strong>Delusion</strong> — Error analysis</li>
                <li><strong>Cognitive</strong> — Technical annotations</li>
            </ul>
        </div>
    </div>
    <!-- Content Container -->
    <div class="content-container">
        <!-- Each layer now wraps iframe in .iframe-wrapper -->
        <div id="introduction" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Introduction</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                <iframe class="layer-frame" data-src="introduction.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="contents" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Contents</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="contents.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="tibetan" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Tibetan</span>
                <span class="header-info">Original Tibetan</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="tibetan.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="wylie" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Wylie</span>
                <span class="header-info">Transliteration</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="wylie.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="literal" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Literal</span>
                <span class="header-info">Word-by-Word</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="literal.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="liturgical" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Liturgical</span>
                <span class="header-info">Poetic Chant</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="liturgical.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="commentary" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Commentary</span>
                <span class="header-info">Philosophical</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="commentary.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="scholar" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Scholar</span>
                <span class="header-info">Academic</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="scholar.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="epistemic" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Epistemic</span>
                <span class="header-info">View & Pedagogy</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="epistemic.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="delusion" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Delusion</span>
                <span class="header-info">Error Analysis</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="delusion.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="cognitive" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Cognitive</span>
                <span class="header-info">Annotations</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="cognitive.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="glossary" class="layer-content">
            <div class="layer-header">
                <span class="header-title">Glossary</span>
                <span class="header-indicator"></span>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="glossary.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="conventions" class="layer-content">
            <div class="layer-header">
                <h1>Editorial Conventions</h1>
                <div class="subtitle" id="conventions-subtitle">Layer Methodology</div>
            </div>
            <div class="iframe-wrapper">
                <iframe id="conventions-frame" class="layer-frame" data-src="conventions.html" scrolling="auto"></iframe>
            </div>
        </div>
    </div>
    <!-- Line Indicator -->
    <div id="line-indicator" class="line-indicator"></div>
    <script src="../js/aln_data.js"></script>
    <script>
    // ==========================================================================
    // UNIFIED STATE MANAGEMENT - ALN (Absolute Line Numbers)
    // ==========================================================================
    // All line numbers are ALN (Absolute Line Numbers 1-37756)
    // Volume is derived from ALN: line <= 20426 ? 1 : 2
    
    // ALN is now loaded from ../js/aln_data.js (embedded, file:// compatible)
    
    // Initialize chapter dropdown on load
    document.addEventListener('DOMContentLoaded', function() {
        populateChapterDropdown();
        // If there's a saved line in state, update the chapter dropdown
        if (state.line) {
            updateChapterDropdown();
        }
    });
    
    // Chapter names mapping
    const chapterNames = {
        '01-01': '1. The Perfect Teacher',
        '01-02': '2. Container and Contents',
        '01-03': '3. Aggregates and Elements',
        '01-04': '4. Vehicle Enumeration',
        '01-05': '5. Empowerment and Samaya',
        '01-06': '6. Samaya Discipline',
        '01-07': '7. Samaya Restoration',
        '01-08': '8. Ground, Path, Fruit',
        '01-09': '9. Delusion and Liberation',
        '01-10': '10. Arising of Elements',
        '01-11': '11. Body Formation',
        '01-12': '12. Bindu, Channels, Winds',
        '01-13': '13. Luminosity',
        '01-14': '14. Mind and Awareness',
        '02-15': '15. Elements Place',
        '02-16': '16. Kaya and Wisdom',
        '02-17': '17. Path and Signs',
        '02-18': '18. Luminosity Path',
        '02-19': '19. Cutting Through',
        '02-20': '20. Leap-Over',
        '02-21': '21. Introduction',
        '02-22': '22. Signs of Liberation',
        '02-23': '23. Intermediate State',
        '02-24': '24. Emanation Field',
        '02-25': '25. Fruition'
    };
    
    // Populate chapter dropdown from ALN.chapterMap
    function populateChapterDropdown() {
        const dropdown = document.getElementById('chapter-select');
        if (!dropdown) return;
        
        // Wait for ALN to be ready
        if (!ALN || !ALN.chapterMap) {
            setTimeout(populateChapterDropdown, 200);
            return;
        }
        
        dropdown.innerHTML = '<option value="">Select Chapter...</option>';
        
        // Sort chapter map keys
        const sortedKeys = Object.keys(ALN.chapterMap).sort();
        
        for (const key of sortedKeys) {
            const info = ALN.chapterMap[key];
            const volChap = `${String(info.volume).padStart(2, '0')}-${String(info.chapter).padStart(2, '0')}`;
            const startLine = info.startLine;
            const chapterName = chapterNames[volChap] || `Chapter ${info.chapter}`;
            
            const option = document.createElement('option');
            option.value = startLine;
            option.textContent = chapterName;
            dropdown.appendChild(option);
        }
    }
    
    // Handle chapter selection
    function handleChapterSelect(value) {
        if (!value) return;
        const targetLayer = state.selectedLayer || state.layer || 'liturgical';
        const startLine = parseInt(value);
        if (!isNaN(startLine)) {
            window.location.hash = buildHash(targetLayer, startLine);
        }
    }
    
    // Handle prev button click
    function handlePrev() {
        if (!state.layer) return;
        
        // Handle conventions tab - cycle through layers
        if (state.layer === 'conventions') {
            const conventionsLayers = ['tibetan', 'wylie', 'literal', 'liturgical', 'commentary', 'scholar', 'epistemic', 'delusion', 'cognitive'];
            const iframe = document.querySelector('#conventions-frame');
            const currentParams = new URLSearchParams(iframe.src.split('?')[1] || '');
            const currentLayer = currentParams.get('layer') || 'liturgical';
            const currentIndex = conventionsLayers.indexOf(currentLayer);
            const prevIndex = (currentIndex - 1 + conventionsLayers.length) % conventionsLayers.length;
            const newLayer = conventionsLayers[prevIndex];
            
            iframe.src = iframe.dataset.src + '?layer=' + newLayer;
            
            // Update layer dropdown
            document.getElementById('layer-select').value = '#' + newLayer;
            return;
        }
        
        const iframe = document.querySelector(`#${state.layer} .layer-frame`);
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({ type: 'prevChapter' }, '*');
        }
    }
    
    // Handle next button click
    function handleNext() {
        if (!state.layer) return;
        
        // Handle conventions tab - cycle through layers
        if (state.layer === 'conventions') {
            const conventionsLayers = ['tibetan', 'wylie', 'literal', 'liturgical', 'commentary', 'scholar', 'epistemic', 'delusion', 'cognitive'];
            const iframe = document.querySelector('#conventions-frame');
            const currentParams = new URLSearchParams(iframe.src.split('?')[1] || '');
            const currentLayer = currentParams.get('layer') || 'liturgical';
            const currentIndex = conventionsLayers.indexOf(currentLayer);
            const nextIndex = (currentIndex + 1) % conventionsLayers.length;
            const newLayer = conventionsLayers[nextIndex];
            
            iframe.src = iframe.dataset.src + '?layer=' + newLayer;
            
            // Update layer dropdown
            document.getElementById('layer-select').value = '#' + newLayer;
            return;
        }
        
        const iframe = document.querySelector(`#${state.layer} .layer-frame`);
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({ type: 'nextChapter' }, '*');
        }
    }
    
    // Update chapter dropdown based on current line
    function updateChapterDropdown() {
        const dropdown = document.getElementById('chapter-select');
        if (!dropdown || !ALN || !state.line) return;
        
        // Find current chapter from line number
        const info = ALN.getInfo(state.line);
        if (!info) return;
        
        const volChap = `${String(info.volume).padStart(2, '0')}-${String(info.chapter).padStart(2, '0')}`;
        const startLine = ALN.getStartLineForChapter(info.volume, info.chapter);
        
        // Find and select the option with this startLine
        const options = dropdown.querySelectorAll('option');
        for (const option of options) {
            if (parseInt(option.value) === startLine) {
                dropdown.value = option.value;
                return;
            }
        }
    }
    
    
    // Unified state object - stored in sessionStorage for persistence
    const state = {
        layer: null,           // Current active layer
        volume: 1,            // Current volume (1 or 2)
        line: null,           // Current absolute line number
        chapter: null,        // Current chapter number
        selectedLayer: null   // Last selected translation/analysis layer
    };
    
    // Load state from sessionStorage
    function loadState() {
        try {
            const saved = sessionStorage.getItem('dzoState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.volume = parsed.volume || 1;
                state.line = parsed.line || null;
                state.chapter = parsed.chapter || null;
                state.selectedLayer = parsed.selectedLayer || localStorage.getItem('selectedLayer') || 'liturgical';
            } else {
                state.selectedLayer = localStorage.getItem('selectedLayer') || 'liturgical';
            }
        } catch (e) {
            state.selectedLayer = localStorage.getItem('selectedLayer') || 'liturgical';
        }
    }
    
    // Save state to sessionStorage
    function saveState() {
        try {
            sessionStorage.setItem('dzoState', JSON.stringify({
                volume: state.volume,
                line: state.line,
                chapter: state.chapter,
                selectedLayer: state.selectedLayer
            }));
        } catch (e) {}
    }
    
    // Update line - ALN is already absolute
    function setLine(absLine) {
        if (absLine && !isNaN(parseInt(absLine))) {
            state.line = parseInt(absLine);
            // Derive volume from ALN
            if (ALN) {
                const info = ALN.getInfo(state.line);
                state.volume = info ? info.volume : (state.line <= 20426 ? 1 : 2);
                state.chapter = info ? info.chapter : null;
            } else {
                state.volume = state.line <= 20426 ? 1 : 2;
            }
            saveState();
            updateChapterDropdown();
            updateHeaderIndicator();
        }
    }
    
    // Update header indicator with current volume and chapter
    function updateHeaderIndicator() {
        const indicator = document.querySelector('.layer-content.active .header-indicator');
        if (!indicator || !state.volume || !state.chapter) {
            return;
        }
        indicator.textContent = 'V' + state.volume + ' Ch' + state.chapter;
    }
    
    // Set volume (derived from ALN, but can be set explicitly for backward compat)
    function setVolume(vol) {
        if (vol === 1 || vol === 2) {
            // When setting volume, adjust line to be in that volume's range
            // This is for backward compatibility - prefer using ALN directly
            if (state.line) {
                if (vol === 1 && state.line > 20426) {
                    // Moving to volume 1 - not really valid, just derive
                    state.volume = 1;
                } else if (vol === 2 && state.line <= 20426) {
                    // Moving to volume 2 - find first line of volume 2
                    state.line = 20427;
                    state.volume = 2;
                } else {
                    state.volume = vol;
                }
                if (ALN) {
                    const info = ALN.getInfo(state.line);
                    state.chapter = info ? info.chapter : null;
                }
            } else {
                state.volume = vol;
            }
            saveState();
        }
    }
    
    // Set layer
    function setLayer(layerId) {
        state.layer = layerId;
        if (layerId && layerId !== 'contents' && layerId !== 'glossary' && 
            layerId !== 'conventions' && layerId !== 'introduction') {
            state.selectedLayer = layerId;
            localStorage.setItem('selectedLayer', layerId);
        }
        saveState();
    }
    
    // Build hash from current state - ALN format: #layer:LINE
    function buildHash(layer, line) {
        if (line && !isNaN(line)) {
            return `#${layer}:${line}`;
        }
        return `#${layer}`;
    }
    
    // Initialize state
    loadState();

    // ==========================================================================
    // LAYER CONFIGURATION
    // ==========================================================================
    
    const layers = {
        'introduction': { type: 'nav', hasLineRange: false },     // Chapter-based navigation
        'contents': { type: 'nav', hasLineRange: false },         // Table of contents
        'conventions': { type: 'info', hasLineRange: false },    // Static info page
        'glossary': { type: 'nav', hasLineRange: false },        // Glossary
        // Translation layers - exact line matching
        'tibetan': { type: 'translation', hasLineRange: false },
        'wylie': { type: 'translation', hasLineRange: false },
        'literal': { type: 'translation', hasLineRange: false },
        'liturgical': { type: 'translation', hasLineRange: false },
        // Analysis layers - range-based matching
        'commentary': { type: 'analysis', hasLineRange: true },
        'scholar': { type: 'analysis', hasLineRange: true },
        'epistemic': { type: 'analysis', hasLineRange: true },
        'delusion': { type: 'analysis', hasLineRange: true },
        'cognitive': { type: 'analysis', hasLineRange: true }
    };
    
    // Translation/analysis layers that support line navigation
    const lineLayers = ['tibetan', 'wylie', 'literal', 'liturgical', 
                        'commentary', 'scholar', 'epistemic', 'delusion', 'cognitive'];
    
    // Nav layers that should preserve line when leaving
    const navLayers = ['contents', 'glossary', 'conventions', 'introduction'];

    // Helper to get chapter from ALN (uses ALN module)
    function getChapterFromALN(lineNum) {
        if (ALN) {
            return ALN.getChapterFromALN(lineNum);
        }
        // Fallback without ALN
        return lineNum <= 20426 ? Math.ceil(lineNum / 1500) : 14 + Math.ceil((lineNum - 20426) / 1500);
    }

    // ==========================================================================
    // DOM ELEMENTS
    // ==========================================================================
    
    const welcomeScreen = document.getElementById('welcome');
    const lineIndicator = document.getElementById('line-indicator');
    const navTabs = document.querySelectorAll('.nav-tab');
    const consentModal = document.getElementById('consent-modal');
    const consentImage1 = document.getElementById('consent-image-1');
    const consentImage2 = document.getElementById('consent-image-2');

    document.querySelectorAll('.layer-frame').forEach(iframe => { iframe.src = 'about:blank'; });

    // ==========================================================================
    // CONSENT HANDLING
    // ==========================================================================
    
    if (localStorage.getItem('consentAccepted') === 'true' &&
        localStorage.getItem('imageConsent1Accepted') === 'true' &&
        localStorage.getItem('imageConsent2Accepted') === 'true') {
        consentModal.classList.add('hidden');
        consentImage1.classList.add('hidden');
        consentImage2.classList.add('hidden');
    } else if (localStorage.getItem('consentAccepted') === 'true' &&
               localStorage.getItem('imageConsent1Accepted') === 'true') {
        consentModal.classList.add('hidden');
        consentImage1.classList.add('hidden');
        consentImage2.classList.remove('hidden');
    } else if (localStorage.getItem('consentAccepted') === 'true') {
        consentModal.classList.add('hidden');
        consentImage1.classList.remove('hidden');
    }

    function acceptConsent() {
        localStorage.setItem('consentAccepted', 'true');
        consentModal.classList.add('hidden');
        consentImage1.classList.remove('hidden');
    }

    function acceptImageConsent1() {
        localStorage.setItem('imageConsent1Accepted', 'true');
        consentImage1.classList.add('hidden');
        consentImage2.classList.remove('hidden');
    }

    function acceptImageConsent2() {
        localStorage.setItem('imageConsent2Accepted', 'true');
        consentImage2.classList.add('hidden');
    }

    // ==========================================================================
    // LAYER SELECTION (Dropdown)
    // ==========================================================================
    
    function handleLayerSelect(value) {
        if (!value) return;
        const targetLayer = value.slice(1);
        
        // Handle conventions specially - it loads different content based on layer param
        if (state.layer === 'conventions') {
            const iframe = document.querySelector('#conventions-frame');
            if (iframe) {
                let effectiveLayer = targetLayer;
                if (effectiveLayer === 'introduction') effectiveLayer = 'liturgical';
                iframe.src = iframe.dataset.src + '?layer=' + effectiveLayer;
            }
            setLayer(targetLayer);
            return;
        }
        
        // If we have a current line and target is a line layer, navigate with line preserved
        if (state.line && lineLayers.includes(targetLayer)) {
            window.location.hash = buildHash(targetLayer, state.line);
        } else {
            window.location.hash = '#' + targetLayer;
        }
    }

    function updateLayerDropdown(layerId) {
        const dropdown = document.getElementById('layer-select');
        if (!dropdown) return;
        
        const allLayers = ['introduction', 'tibetan', 'wylie', 'literal', 'liturgical', 
                          'commentary', 'scholar', 'epistemic', 'delusion', 'cognitive'];
        if (allLayers.includes(layerId)) {
            dropdown.value = '#' + layerId;
        } else {
            const lastLayer = state.selectedLayer || localStorage.getItem('selectedLayer');
            if (lastLayer && allLayers.includes(lastLayer)) {
                dropdown.value = '#' + lastLayer;
            } else {
                dropdown.value = '#liturgical';
            }
        }
    }

    // ==========================================================================
    // HASH PARSING & NAVIGATION
    // ==========================================================================
    
    // Hash format: #layer:ALN
    // Examples:
    //   #tibetan:5000    -> tibetan layer, ALN 5000
    //   #liturgical:20500 -> liturgical layer, ALN 20500
    //   #contents        -> contents page (no line)
    //   #tibetan         -> tibetan layer (no line specified)
    
    function parseHash(hash) {
        const result = { layer: null, line: null };
        
        if (!hash) return result;
        
        // Remove leading #
        const str = hash.replace(/^#/, '');
        const parts = str.split(':');
        
        result.layer = parts[0] || null;
        
        // New format: #layer:ALN
        if (parts.length >= 2 && parts[1]) {
            result.line = parseInt(parts[1]);
        }
        
        return result;
    }
    
    function handleNavigation() {
        const hashData = parseHash(window.location.hash);
        
        if (!hashData.layer) {
            showWelcome();
            return;
        }
        
        if (!layers[hashData.layer]) {
            showWelcome();
            return;
        }
        
        // Only use URL line when coming FROM a nav layer (contents/introduction/etc)
        // When switching between line layers, preserve state.line (current scroll position)
        const wasOnNavLayer = !state.layer || navLayers.includes(state.layer);
        
        let lineToUse = null;
        
        if (wasOnNavLayer && hashData.line) {
            // Coming from nav layer - use URL line
            setLine(hashData.line);
            lineToUse = hashData.line;
        }
        // Otherwise (switching between line layers), keep state.line as-is - don't use URL line
        
        showLayer(hashData.layer, lineToUse);
    }

    function showWelcome() {
        welcomeScreen.style.display = 'flex';
        document.querySelectorAll('.layer-content').forEach(el => el.classList.remove('active'));
        
        navTabs.forEach(tab => {
            const href = tab.getAttribute('href');
            if (href === '#' + state.selectedLayer) {
                tab.classList.add('active');
            } else if (href !== '#contents' && href !== '#introduction') {
                tab.classList.remove('active');
            }
        });
        
        updateLayerDropdown(state.selectedLayer);
        state.layer = null;
        hideLineIndicator();
    }

    function showLayer(layerId, targetLine) {
        welcomeScreen.style.display = 'none';
        
        // Update state - ALN is already absolute
        if (targetLine) setLine(targetLine);
        setLayer(layerId);
        
        // Update nav tabs
        navTabs.forEach(tab => {
            const href = tab.getAttribute('href');
            const tabLayer = href.slice(1);
            
            if (navLayers.includes(layerId)) {
                // On nav layer - highlight selected translation layer
                if (href === '#' + state.selectedLayer) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            } else {
                // On line layer - highlight current layer
                tab.classList.toggle('active', tabLayer === layerId);
            }
        });

        document.querySelectorAll('.layer-content').forEach(el => {
            el.classList.toggle('active', el.id === layerId);
        });

        const iframe = document.querySelector(`#${layerId} .layer-frame`);
        const lineToUse = targetLine || state.line;

        if (iframe) {
            const needsLoad = iframe.src === 'about:blank' || !iframe.src || iframe.src === 'about:blank';
            let src = iframe.dataset.src;
            
            if (layerId === 'conventions') {
                let dropdownLayer = document.getElementById('layer-select').value.replace('#', '');
                if (dropdownLayer === 'introduction') dropdownLayer = 'liturgical';
                src += '?layer=' + dropdownLayer;
                if (!needsLoad) {
                    iframe.src = src;
                    updateLayerDropdown(layerId);
                    return;
                }
            } else if (layerId === 'introduction') {
                // Use ALN to get chapter ID
                const aln = lineToUse || 1;
                let chapterId = '01-01';
                if (ALN) {
                    const info = ALN.getInfo(aln);
                    if (info) {
                        chapterId = `${String(info.volume).padStart(2, '0')}-${String(info.chapter).padStart(2, '0')}`;
                    }
                }
                src += '#chapter-' + chapterId;
                if (!needsLoad) {
                    iframe.contentWindow.location.hash = '#chapter-' + chapterId;
                }
            } else if (lineLayers.includes(layerId) && lineToUse && !isNaN(lineToUse)) {
                // Pass ALN directly to iframe - layers now use ALN
                src += `#line-${lineToUse}`;
            }
            
            // Always update src when line changes, not just on initial load
            if (needsLoad) {
                iframe.src = src;
            } else if (lineLayers.includes(layerId) && lineToUse && !isNaN(lineToUse)) {
                // Iframe already loaded - just update its hash to navigate to correct position
                iframe.contentWindow.location.hash = `#line-${lineToUse}`;
            }
        }

        updateLayerDropdown(layerId);
        updateChapterDropdown();
        updateHeaderIndicator();
        
        // // Hide chapter dropdown and nav buttons when on conventions (they don't apply)
        // const chapterSelect = document.getElementById('chapter-select');
        // const navBtns = document.querySelectorAll('.toolbar-nav-btn');
        // if (layerId === 'conventions') {
        //     if (chapterSelect) chapterSelect.style.display = 'none';
        //     navBtns.forEach(btn => btn.style.display = 'none');
        // } else if (layerId) {
        //     if (chapterSelect) chapterSelect.style.display = '';
        //     navBtns.forEach(btn => btn.style.display = '');
        // }
    }

    // ==========================================================================
    // GET LINE FROM IFRAME (for preserving position when switching)
    // ==========================================================================
    
    function getCurrentLineFromIframe(layerId) {
        const iframe = document.querySelector(`#${layerId} .layer-frame`);
        if (!iframe || !iframe.contentDocument) {
            return null;
        }
        try {
            const doc = iframe.contentDocument;
            
            // Try to find line element at top of viewport
            const topElement = doc.elementFromPoint(50, 100);
            if (topElement) {
                let el = topElement;
                while (el && el !== doc.body) {
                    if (el.id && el.id.startsWith('line-')) {
                        const lineNum = el.id.replace('line-', '');
                        // For range-based layers, we need range data
                        if (layers[layerId] && layers[layerId].hasLineRange) {
                            const rangeStart = el.dataset.rangeStart;
                            const rangeEnd = el.dataset.rangeEnd;
                            if (rangeStart) {
                                return { 
                                    line: parseInt(rangeStart), 
                                    isRange: true,
                                    rangeStart: parseInt(rangeStart),
                                    rangeEnd: parseInt(rangeEnd)
                                };
                            }
                        }
                        return { line: parseInt(lineNum), isRange: false };
                    }
                    el = el.parentElement;
                }
            }
            
            // Fallback: find any line element near top of viewport
            const lines = doc.querySelectorAll('[id^="line-"]');
            const iframeRect = iframe.getBoundingClientRect();
            for (const line of lines) {
                const lineRect = line.getBoundingClientRect();
                if (lineRect.top >= iframeRect.top && lineRect.top <= iframeRect.top + 200) {
                    if (layers[layerId] && layers[layerId].hasLineRange) {
                        const rangeStart = line.dataset.rangeStart;
                        const rangeEnd = line.dataset.rangeEnd;
                        if (rangeStart) {
                            return { 
                                line: parseInt(rangeStart), 
                                isRange: true,
                                rangeStart: parseInt(rangeStart),
                                rangeEnd: parseInt(rangeEnd)
                            };
                        }
                    }
                    return { line: parseInt(line.id.replace('line-', '')), isRange: false };
                }
            }
            return null;
        } catch (e) {
            console.log('Error getting line from iframe:', e);
            return null;
        }
    }

    // ==========================================================================
    // TAB CLICK HANDLERS
    // ==========================================================================
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            const targetLayer = this.getAttribute('href').slice(1);
            
            // Already on target layer
            if (state.layer === targetLayer) return;
            
            // Going TO a nav layer (contents/glossary/conventions/introduction)
            if (navLayers.includes(targetLayer)) {
                // If coming from a line layer, state.line is already being updated via postMessage
                // Let normal navigation proceed - it will handle the hash change
                return;
            }
            
            // Going TO a line layer
            if (lineLayers.includes(targetLayer)) {
                e.preventDefault();
                
                // ALWAYS use state.line which is being continuously updated via postMessage from scroll
                // Don't try to get from iframe at click time - it's unreliable
                if (state.line) {
                    window.location.hash = buildHash(targetLayer, state.line);
                } else {
                    window.location.hash = '#' + targetLayer;
                }
            }
        });
    });

    // ==========================================================================
    // MESSAGE HANDLING (from iframes)
    // ==========================================================================
    
    let scrollSyncDebounce = null;
    
    window.addEventListener('message', function(e) {
        if (!e.data || !e.data.type) return;
        
        // Handle navigateToLine (from contents page) - ALN only
        if (e.data.type === 'navigateToLine') {
            const lineNum = parseInt(e.data.line);
            if (!isNaN(lineNum)) {
                setLine(lineNum);
                const targetLayer = state.selectedLayer || 'liturgical';
                window.location.hash = buildHash(targetLayer, state.line);
            }
            return;
        }
        
        // Handle linePosition updates (from translation/analysis layers) - ALN only
        if (e.data.type === 'linePosition') {
            const lineNum = parseInt(e.data.line);
            if (!isNaN(lineNum)) {
                // Debounce scroll updates to avoid excessive processing
                clearTimeout(scrollSyncDebounce);
                scrollSyncDebounce = setTimeout(() => {
                    setLine(lineNum);
                }, 100);
            }
            return;
        }
        
        // Handle rangePosition (from analysis layers) - ALN only
        if (e.data.type === 'rangePosition') {
            const rangeStart = parseInt(e.data.rangeStart);
            if (!isNaN(rangeStart)) {
                clearTimeout(scrollSyncDebounce);
                scrollSyncDebounce = setTimeout(() => {
                    setLine(rangeStart);
                }, 100);
            }
            return;
        }
        
        // Handle chapterPosition (from introduction) - ALN only
        if (e.data.type === 'chapterPosition') {
            const lineNum = parseInt(e.data.line);
            if (!isNaN(lineNum)) {
                setLine(lineNum);
            }
            return;
        }
        
        // Handle chapterChanged (from prev/next buttons in iframes) - ALN only
        if (e.data.type === 'chapterChanged') {
            const lineNum = parseInt(e.data.line);
            if (lineNum) {
                setLine(lineNum);
                // Update URL to reflect new chapter position
                if (state.layer && lineLayers.includes(state.layer)) {
                    window.location.hash = buildHash(state.layer, state.line);
                }
            }
            return;
        }
    });

    // ==========================================================================
    // LINE INDICATOR
    // ==========================================================================
    
    function showLineIndicator(layer, line, type) {
        const names = {
            introduction: 'Introduction',
            tibetan: 'Tibetan',
            glossary: 'Glossary',
            wylie: 'Wylie',
            literal: 'Literal',
            liturgical: 'Liturgical',
            commentary: 'Commentary',
            scholar: 'Scholar',
            epistemic: 'Epistemic',
            delusion: 'Delusion',
            cognitive: 'Cognitive',
            contents: 'Contents'
        };
        const volumeText = state.volume ? ` (Vol ${state.volume})` : '';
        lineIndicator.textContent = `${names[layer] || layer}: Line ${line}${type === 'range' ? ' (range)' : ''}${volumeText}`;
        lineIndicator.classList.add('visible');
        setTimeout(() => lineIndicator.classList.remove('visible'), 3000);
    }

    function hideLineIndicator() { 
        lineIndicator.classList.remove('visible'); 
    }

    // ==========================================================================
    // HASH CHANGE & INITIALIZATION
    // ==========================================================================
    
    window.addEventListener('hashchange', handleNavigation);

    document.querySelectorAll('.layer-frame').forEach(iframe => {
        iframe.addEventListener('load', function() {
            if (!state.layer) return;
            try {
                const doc = this.contentDocument;
                // Ensure line IDs exist for tibetan/wylie
                if (state.layer === 'tibetan' || state.layer === 'wylie') {
                    doc.querySelectorAll('[class*="line-num"]').forEach(el => {
                        const t = el.textContent.trim();
                        if (t && /^\d+$/.test(t)) el.id = 'line-' + t;
                    });
                }
                if (state.line && lineLayers.includes(state.layer)) {
                    const type = layers[state.layer].hasLineRange ? 'range' : 'exact';
                    showLineIndicator(state.layer, state.line, type);
                }
            } catch (e) {}
        });
    });

    // ==========================================================================
    // DARK MODE
    // ==========================================================================
    
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const btn = document.querySelector('.dark-mode-toggle');
        btn.textContent = document.body.classList.contains('dark-mode') ? 'Light' : 'Dark';
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        
        document.querySelectorAll('.layer-frame').forEach(iframe => {
            try {
                iframe.contentWindow.postMessage({
                    type: 'darkModeChange',
                    enabled: document.body.classList.contains('dark-mode')
                }, '*');
            } catch (e) {}
        });
    }

    if (localStorage.getItem('darkMode') === 'false') {
        document.body.classList.remove('dark-mode');
        document.querySelector('.dark-mode-toggle').textContent = 'Dark';
    } else {
        document.body.classList.add('dark-mode');
        document.querySelector('.dark-mode-toggle').textContent = 'Light';
    }

    // Initialize
    handleNavigation();
    </script>
</body>

</html>
