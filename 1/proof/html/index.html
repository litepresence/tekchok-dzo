<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury of the Supreme Vehicle — 9 Layers</title>
    <meta name="generator" content="Layer Splash Page">
    <style>
    :root {
        --font-main: 'Georgia', 'Times New Roman', serif;
        --font-mono: 'Consolas', 'Courier New', monospace;
        /* Light mode */
        --color-bg: #fafafa;
        --color-bg-secondary: #fff;
        --color-bg-tertiary: #f5f5f5;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-shadow: rgba(0, 0, 0, 0.1);
        --color-nav-bg: #fff;
        --color-nav-border: #ddd;
        --color-toggle-bg: #fff;
        --color-toggle-text: #333;
        --color-toggle-border: #999;
        --color-toggle-hover: #eee;
        /* Layer colors */
        --color-tibetan: #2c5f7f;
        --color-wylie: #5d4037;
        --color-literal: #2e7d32;
        --color-liturgical: #6a1b9a;
        --color-commentary: #f57c00;
        --color-scholar: #00838f;
        --color-epistemic: #ad1457;
        --color-delusion: #c62828;
        --color-cognitive: #455a64;
        --color-glossary: #77d3ff;
        --color-contents: #37474f;
    }

    /* Dark mode variable overrides */
    body.dark-mode {
        --color-bg: #1a1a1a;
        --color-bg-secondary: #2d2d2d;
        --color-bg-tertiary: #3a3a3a;
        --color-text: #f0f0f0;
        --color-muted: #aaa;
        --color-border: #444;
        --color-shadow: rgba(0, 0, 0, 0.4);
        --color-nav-bg: #1e1e1e;
        --color-nav-border: #444;
        --color-toggle-bg: #333;
        --color-toggle-text: #fff;
        --color-toggle-border: #666;
        --color-toggle-hover: #444;
    }

    * {
        box-sizing: border-box;
    }

    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-main);
        color: var(--color-text);
        line-height: 1.6;
        background: var(--color-bg);
        transition: background-color 0.3s ease, color 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    /* Navigation */
    .nav-container {
        position: sticky;
        top: 0;
        background: var(--color-nav-bg);
        border-bottom: 2px solid var(--color-nav-border);
        z-index: 1000;
        padding: 0.5em 1em;
        box-shadow: 0 2px 4px var(--color-shadow);
        transition: background-color 0.3s ease, border-color 0.3s ease;
        flex-shrink: 0;
    }

    .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25em;
        justify-content: center;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    .nav-divider {
        width: 1px;
        height: 24px;
        background: var(--color-border);
        margin: 0 0.5em;
    }

    .dark-mode-toggle {
        margin-left: auto;
        padding: 0.4em 0.8em;
        border: 1px solid var(--color-toggle-border);
        border-radius: 4px;
        background: var(--color-toggle-bg);
        color: var(--color-toggle-text);
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dark-mode-toggle:hover {
        background: var(--color-toggle-hover);
    }

    .nav-tab {
        padding: 0.5em 1em 0.5em 1.8em;
        border: none;
        border-radius: 999px;
        font-family: var(--font-main);
        font-size: 0.85em;
        cursor: pointer;
        text-decoration: none;
        color: #fff;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
    }

    .nav-tab::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border: 2px solid rgba(255,255,255,0.5);
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .nav-tab:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .nav-tab.active::before {
        background: #fff;
        border-color: #fff;
    }

    .nav-tab.active {
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(255,255,255,0.4);
        font-weight: bold;
    }

    .nav-tab.introduction {
        background: var(--color-tibetan);
    }

    .nav-tab.introduction.active {
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(255,255,255,0.4);
        font-weight: bold;
    }

    .nav-tab.contents {
        background: var(--color-contents);
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.contents::before {
        display: none;
    }

    .nav-tab.contents.active {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .nav-tab.conventions {
        background: #6d4c41;
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.conventions::before {
        display: none;
    }

    .nav-tab.conventions:hover {
        background: #8d6e63;
    }

    .layer-dropdown {
        background: var(--color-tibetan);
        color: var(--color-text);
        border: none;
        border-radius: 4px;
        padding: 0.4em 0.8em;
        font-family: var(--font-sans);
        font-size: 0.85em;
        cursor: pointer;
        outline: none;
    }

    .layer-dropdown:hover {
        background: var(--color-tibetan-hover, #3d6a8b);
    }

    .layer-dropdown:focus {
        box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }

    .layer-dropdown option {
        background: var(--color-bg);
        color: var(--color-text);
    }

    .nav-tab.tibetan {
        background: var(--color-tibetan);
    }

    .nav-tab.wylie {
        background: var(--color-wylie);
    }

    .nav-tab.literal {
        background: var(--color-literal);
    }

    .nav-tab.liturgical {
        background: var(--color-liturgical);
    }

    .nav-tab.commentary {
        background: var(--color-commentary);
    }

    .nav-tab.scholar {
        background: var(--color-scholar);
    }

    .nav-tab.epistemic {
        background: var(--color-epistemic);
    }

    .nav-tab.delusion {
        background: var(--color-delusion);
    }

    .nav-tab.cognitive {
        background: var(--color-cognitive);
    }

    .nav-tab.glossary {
        background: var(--color-glossary);
        border-radius: 4px;
        padding: 0.5em 1em;
    }

    .nav-tab.glossary::before {
        display: none;
    }

        .nav-tab.glossary.active {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Content layers */
    .content-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .layer-content {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
    }

    .layer-content.active {
        display: flex;
    }

    .layer-header {
        padding: 1em 1.5em;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg-secondary);
    }

    .layer-header h1 {
        margin: 0;
        font-size: 1.5em;
        color: var(--color-text);
    }

    .layer-header .subtitle {
        color: var(--color-muted);
        font-size: 0.9em;
        margin-top: 0.25em;
    }

    .iframe-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
    }

    .layer-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: var(--color-bg);
    }

    /* Line indicator */
    .line-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 0.75em 1em;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 0.85em;
        z-index: 1001;
        display: none;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .line-indicator.visible {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Consent Modal */
    .consent-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 2em;
    }

    .consent-modal.hidden {
        display: none;
    }

    .consent-content {
        max-width: 900px;
        text-align: center;
        padding: 0 1em;
    }

    .consent-header {
        margin-bottom: 1.5em;
    }

    .consent-header .main-title {
        font-size: 1.1em;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5em;
    }

    .consent-header .title {
        font-size: 2.2em;
        color: var(--color-tibetan);
        margin: 0.3em 0;
        font-weight: normal;
    }

    .consent-header .author {
        font-size: 1.1em;
        color: var(--color-muted);
        font-style: italic;
        margin-bottom: 0.5em;
    }

    .consent-header .subtitle {
        font-size: 1.1em;
        color: var(--color-text);
    }

    .consent-divider {
        width: 60%;
        height: 1px;
        background: var(--color-border);
        margin: 1.5em auto;
    }

    .consent-description {
        text-align: justify;
        line-height: 1.8;
        color: var(--color-text);
        font-size: 0.95em;
        margin-bottom: 1.5em;
    }

    .consent-disclaimer {
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1.5em;
        margin: 1.5em 0;
        text-align: left;
    }

    .consent-disclaimer ol {
        margin: 0;
        padding-left: 1.5em;
    }

    .consent-disclaimer li {
        margin-bottom: 0.5em;
        line-height: 1.5;
    }

    .consent-agree-btn {
        display: inline-block;
        background: var(--color-tibetan);
        color: #fff;
        border: none;
        padding: 1em 2.5em;
        font-size: 1em;
        font-family: var(--font-main);
        cursor: pointer;
        border-radius: 4px;
        margin-top: 1.5em;
        transition: all 0.2s ease;
    }

    .consent-agree-btn:hover {
        background: #3a7a9f;
        transform: translateY(-1px);
    }

    .consent-footer {
        margin-top: 2em;
        color: var(--color-muted);
        font-size: 0.85em;
    }

    .consent-footer .license {
        margin-bottom: 0.5em;
    }

    .consent-footer .verse {
        font-style: italic;
        margin: 1em 0;
        line-height: 1.6;
    }

    .consent-footer .translator {
        margin-top: 1em;
    }

    .consent-footer .report {
        margin-top: 1em;
        font-size: 0.8em;
    }

    .consent-footer a {
        color: var(--color-tibetan);
        text-decoration: none;
    }

    .consent-footer a:hover {
        text-decoration: underline;
    }

    /* Image Consent Modal */
    .consent-image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 2em;
    }

    .consent-image-modal.hidden {
        display: none;
    }

    .consent-image-content {
        max-width: 900px;
        text-align: center;
        padding: 0 1em;
    }

    .consent-image-content img {
        max-width: 100%;
        max-height: 60vh;
        object-fit: contain;
        border-radius: 8px;
        margin-bottom: 1.5em;
        box-shadow: 0 4px 20px var(--color-shadow);
    }

    .consent-image-content .image-caption {
        color: var(--color-muted);
        font-style: italic;
        margin-bottom: 1em;
        font-size: 0.9em;
    }

    .consent-image-content .confirm-text {
        color: var(--color-text);
        font-size: 1.1em;
        margin-bottom: 1em;
    }

    /* Welcome screen */
    .welcome-screen {
        text-align: center;
        padding: 4em 2em;
        background: var(--color-bg-secondary);
        flex: 1;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease;
    }

    .welcome-screen h1 {
        font-size: 2.5em;
        color: var(--color-tibetan);
        margin-bottom: 0.5em;
    }

    .welcome-screen .subtitle {
        font-size: 1.2em;
        color: var(--color-muted);
        margin-bottom: 2em;
    }

    .welcome-screen .description {
        max-width: 600px;
        margin: 0 auto;
        text-align: left;
        color: var(--color-text);
    }

    .welcome-screen .description p {
        margin-bottom: 1em;
    }

    @media (max-width: 768px) {
        .consent-modal,
        .consent-image-modal {
            padding: 1em;
        }

        .consent-header .main-title {
            font-size: 0.9em;
        }

        .consent-header .title {
            font-size: 1.6em;
        }

        .consent-header .author,
        .consent-header .subtitle {
            font-size: 1em;
        }

        .consent-description {
            font-size: 0.9em;
            text-align: left;
        }

        .consent-disclaimer {
            padding: 1em;
        }

        .consent-disclaimer li {
            font-size: 0.85em;
        }

        .consent-agree-btn {
            padding: 0.8em 1.5em;
            font-size: 0.9em;
        }

        .consent-footer {
            font-size: 0.8em;
        }

        .consent-footer .verse {
            font-size: 0.9em;
        }

        .consent-image-content img {
            max-height: 50vh;
        }

        .consent-image-content .confirm-text {
            font-size: 1em;
        }

        .nav-tabs {
            gap: 0.15em;
        }

        .nav-tab {
            padding: 0.4em 0.6em 0.4em 1.4em;
            font-size: 0.75em;
        }

        .nav-tab::before {
            left: 6px;
            width: 6px;
            height: 6px;
        }

        .nav-tab.introduction {
            padding: 0.4em 0.6em 0.4em 1.4em;
            font-size: 0.75em;
        }

        .nav-tab.introduction::before {
            left: 6px;
            width: 6px;
            height: 6px;
        }

        .nav-tab.contents {
            padding: 0.4em 0.6em;
        }

        .nav-divider {
            height: 18px;
            margin: 0 0.25em;
        }
    }
    </style>
</head>

<body>
    <!-- Consent Modal -->
    <div id="consent-modal" class="consent-modal">
        <div class="consent-content">
            <div class="consent-header">
                <div class="main-title">The first complete English translation of</div>
                <h1 class="title">TEKCHOK DZO</h1>
                <div class="author">Longchenpa Rabjam's</div>
                <div class="subtitle">Jewel Treasury of the Supreme Vehicle</div>
                <div class="subtitle">herein abides:</div>
            </div>
            
            <div class="consent-divider"></div>
            
            <div class="consent-description">
                This text is best described as "lineage-restricted esoteric instruction" within the Atiyoga vehicle. It belongs to the Dzogchen "Menngagde" or Instruction Series. This classification indicates it is reserved for initiated students. It requires empowerment and oral transmission from a qualified master. The content covers direct introduction to rigpa. It includes practices like Trekcho and Thogal. These involve the light body and dissolution of elements. In traditional contexts this material is confidential. It is not intended for general intellectual study. The restriction protects the integrity of the practice. It ensures the student has the necessary preparation. Describing it as "empowerment-dependent non-dual instruction" is also accurate. This distinguishes it from exoteric sutra teachings. It aligns with the Nyingma nine-vehicle system where Atiyoga is supreme.
            </div>
            
            <div class="consent-description">
                This translation was produced in a largely autonomous manner utilizing Kimi K2.5 and the agentic framework OpenCode. The final draft was reviewed and revised by additional models including Qwen 3.5, Grok Expert, GPT5, and GLM5.
            </div>
            
            <div class="consent-disclaimer">
                <ol>
                    <li>This is a Restricted Dzogchen text; please consult your lama.</li>
                    <li>This is an unauthorized translation which arose from personal practice.</li>
                    <li>This translation was produced using ~300 hours of AI.</li>
                    <li>The translator does not speak or read Tibetan.</li>
                    <li>This translation may still have significant metaphysical flaws.</li>
                    <li>This website is still under construction.</li>
                    <li>The translator has not read the complete text at this time.</li>
                    <li>The literal translation is 1,500 pages. The liturgical translation is 1,500 pages.</li>
                    <li>The website includes an additional 7,500 pages of AI-generated commentary NOT found in the root text.</li>
                </ol>
            </div>
            
            <button class="consent-agree-btn" onclick="acceptConsent()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
            
            <div class="consent-footer">
                <div class="license">License: Copyleft</div>
                <div>February 20, 2026 (Losar)</div>
                <div class="verse">
                    As the light of presence spontaneously shines forth,<br>
                    ultimately not a single thing has arisen:<br>
                    Ownership finds no ground.
                </div>
                <div class="translator">litepresence — radical dzogchen practitioner and emergent systems engineer</div>
                <div class="report">
                    Report issues at <a href="https://github.com/litepresence/tekchok-dzo" target="_blank">github.com/litepresence/tekchok-dzo</a>.<br>
                    Complete git revision history and prompt engineering are available for review.
                </div>
            </div>
        </div>
    </div>

    <!-- Image Consent Modal 1 -->
    <div id="consent-image-1" class="consent-image-modal hidden">
        <div class="consent-image-content">
            <img src="../images/Longchenpa_line_drawing.jpg" alt="Longchenpa">
            <div class="image-caption">Longchenpa Rabjam (ཀློང་ཆེན་རབ་འབྱམས་པ)</div>
            <div class="confirm-text">Do you confirm your intention to receive this restricted teaching?</div>
            <button class="consent-agree-btn" onclick="acceptImageConsent1()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
        </div>
    </div>

    <!-- Image Consent Modal 2 -->
    <div id="consent-image-2" class="consent-image-modal hidden">
        <div class="consent-image-content">
            <img src="../images/Longchenpa_Nyingthig_Lineage.jpg" alt="Nyingthig Lineage">
            <div class="image-caption">Nyingthig Lineage Masters</div>
            <div class="confirm-text">Do you make this request with pure motivation and proper respect for the lineage?</div>
            <button class="consent-agree-btn" onclick="acceptImageConsent2()">I UNDERSTAND AND AGREE TO THE ABOVE TERMS</button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <a href="#contents" class="nav-tab contents">Contents</a>
            <a href="#conventions" class="nav-tab conventions">Conventions</a>
            <span class="nav-divider"></span>
            <select id="layer-select" class="layer-dropdown" onchange="handleLayerSelect(this.value)">
                <option value="#introduction">Introduction</option>
                <option value="#tibetan">Tibetan</option>
                <option value="#wylie">Wylie</option>
                <option value="#literal">Literal</option>
                <option value="#liturgical" selected>Liturgical</option>
                <option value="#commentary">Commentary</option>
                <option value="#scholar">Scholar</option>
                <option value="#epistemic">Epistemic</option>
                <option value="#delusion">Delusion</option>
                <option value="#cognitive">Cognitive</option>
            </select>
            <span class="nav-divider"></span>
            <a href="#glossary" class="nav-tab glossary">Glossary</a>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">Dark</button>
        </div>
    </nav>
    <!-- Welcome Screen -->
    <div id="welcome" class="welcome-screen">
        <h1>Treasury of the Supreme Vehicle</h1>
        <div class="subtitle">ཐེག་པའི་མཆོག་རིན་པོ་ཆེའི་མཛོད</div>
        <div class="description">
            <p>Welcome to the nine-layer translation of Longchen Rabjampa's masterpiece.
                This interface provides access to parallel views of the text across multiple
                interpretive layers.</p>
            <p><strong>Click any tab above</strong> to explore that layer. When viewing
                Tibetan and Wylie layers, switching between them preserves your scroll
                position by line number. For later layers (Commentary through Cognitive),
                the system finds the nearest matching line range.</p>
            <p>Each layer represents a different aspect of the translation:</p>
            <ul>
                <li><strong>Tibetan</strong> — Original Tibetan text</li>
                <li><strong>Wylie</strong> — Tibetan transliteration</li>
                <li><strong>Literal</strong> — Word-by-word translation</li>
                <li><strong>Liturgical</strong> — Poetic chanting version</li>
                <li><strong>Commentary</strong> — Philosophical interpretation</li>
                <li><strong>Scholar</strong> — Academic analysis</li>
                <li><strong>Epistemic</strong> — View/pedagogy layers</li>
                <li><strong>Delusion</strong> — Error analysis</li>
                <li><strong>Cognitive</strong> — Technical annotations</li>
            </ul>
        </div>
    </div>
    <!-- Content Container -->
    <div class="content-container">
        <!-- Each layer now wraps iframe in .iframe-wrapper -->
        <div id="introduction" class="layer-content">
            <div class="layer-header">
                <h1>Introduction</h1>
                <div class="subtitle">Overview of the Treasury</div>
            </div>
            <div class="iframe-wrapper">
                <iframe class="layer-frame" data-src="introduction.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="contents" class="layer-content">
            <div class="layer-header">
                <h1>Table of Contents</h1>
                <div class="subtitle">Treasury of the Supreme Vehicle</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="contents.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="tibetan" class="layer-content">
            <div class="layer-header">
                <h1>Tibetan</h1>
                <div class="subtitle">Original Tibetan Text · ཡིག་གཟུགས</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="tibetan.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="wylie" class="layer-content">
            <div class="layer-header">
                <h1>Wylie</h1>
                <div class="subtitle">Tibetan Transliteration</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="wylie.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="literal" class="layer-content">
            <div class="layer-header">
                <h1>Literal</h1>
                <div class="subtitle">Word-by-Word Translation</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="literal.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="liturgical" class="layer-content">
            <div class="layer-header">
                <h1>Liturgical</h1>
                <div class="subtitle">Poetic Chant Version</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="liturgical.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="commentary" class="layer-content">
            <div class="layer-header">
                <h1>Commentary</h1>
                <div class="subtitle">Philosophical Interpretation</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="commentary.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="scholar" class="layer-content">
            <div class="layer-header">
                <h1>Scholar</h1>
                <div class="subtitle">Academic Analysis</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="scholar.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="epistemic" class="layer-content">
            <div class="layer-header">
                <h1>Epistemic</h1>
                <div class="subtitle">View &amp; Pedagogy Layers</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="epistemic.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="delusion" class="layer-content">
            <div class="layer-header">
                <h1>Delusion</h1>
                <div class="subtitle">Error Analysis</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="delusion.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="cognitive" class="layer-content">
            <div class="layer-header">
                <h1>Cognitive</h1>
                <div class="subtitle">Technical Annotations</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="cognitive.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="glossary" class="layer-content">
            <div class="layer-header">
                <h1>Glossary</h1>
                <div class="subtitle">Glossary of Terms</div>
            </div>
            <div class="iframe-wrapper">
                
                <iframe class="layer-frame" data-src="glossary.html" scrolling="auto"></iframe>
            </div>
        </div>
        <div id="conventions" class="layer-content">
            <div class="layer-header">
                <h1>Editorial Conventions</h1>
                <div class="subtitle" id="conventions-subtitle">Layer Methodology</div>
            </div>
            <div class="iframe-wrapper">
                <iframe id="conventions-frame" class="layer-frame" data-src="conventions.html" scrolling="auto"></iframe>
            </div>
        </div>
    </div>
    <!-- Line Indicator -->
    <div id="line-indicator" class="line-indicator"></div>
    <script>
    const layers = {
        'introduction': { exactMatch: false, hasRanges: true },
        'contents': { exactMatch: false, hasRanges: false },
        'conventions': { exactMatch: false, hasRanges: false },
        'tibetan': { exactMatch: true, hasRanges: false },
        'wylie': { exactMatch: true, hasRanges: false },
        'literal': { exactMatch: true, hasRanges: false },
        'liturgical': { exactMatch: true, hasRanges: false },
        'commentary': { exactMatch: true, hasRanges: true },
        'scholar': { exactMatch: true, hasRanges: true },
        'epistemic': { exactMatch: true, hasRanges: true },
        'delusion': { exactMatch: true, hasRanges: true },
        'cognitive': { exactMatch: true, hasRanges: true },
        'glossary': { exactMatch: false, hasRanges: true }
    };

    const CHAPTER_MAP = {
        '01-01-00-00': { volume: 1, chapter: 1, startLine: 1 },
        '01-02-00-00': { volume: 1, chapter: 2, startLine: 635 },
        '01-03-00-00': { volume: 1, chapter: 3, startLine: 1582 },
        '01-04-00-00': { volume: 1, chapter: 4, startLine: 1902 },
        '01-05-00-00': { volume: 1, chapter: 5, startLine: 4172 },
        '01-06-00-00': { volume: 1, chapter: 6, startLine: 6801 },
        '01-07-00-00': { volume: 1, chapter: 7, startLine: 9704 },
        '01-08-00-00': { volume: 1, chapter: 8, startLine: 10472 },
        '01-09-00-00': { volume: 1, chapter: 9, startLine: 11335 },
        '01-10-00-00': { volume: 1, chapter: 10, startLine: 12500 },
        '01-11-00-00': { volume: 1, chapter: 11, startLine: 13104 },
        '01-12-00-00': { volume: 1, chapter: 12, startLine: 13831 },
        '01-13-00-00': { volume: 1, chapter: 13, startLine: 16025 },
        '01-14-00-00': { volume: 1, chapter: 14, startLine: 17361 },
        '02-15-00-00': { volume: 2, chapter: 15, startLine: 20427 },
        '02-16-00-00': { volume: 2, chapter: 16, startLine: 20900 },
        '02-17-00-00': { volume: 2, chapter: 17, startLine: 22654 },
        '02-18-00-00': { volume: 2, chapter: 18, startLine: 24822 },
        '02-19-00-00': { volume: 2, chapter: 19, startLine: 26863 },
        '02-20-00-00': { volume: 2, chapter: 20, startLine: 27946 },
        '02-21-00-00': { volume: 2, chapter: 21, startLine: 28946 },
        '02-22-00-00': { volume: 2, chapter: 22, startLine: 29856 },
        '02-23-00-00': { volume: 2, chapter: 23, startLine: 31566 },
        '02-24-00-00': { volume: 2, chapter: 24, startLine: 34830 },
        '02-25-00-00': { volume: 2, chapter: 25, startLine: 35191 }
    };
    
    function findChapterFromLine(lineNum, volume) {
        volume = volume || currentVolume;
        let bestMatch = '01-01-00-00';
        let bestStart = 0;
        for (const [chapterId, data] of Object.entries(CHAPTER_MAP)) {
            if (data.volume === volume && data.startLine <= lineNum && data.startLine > bestStart) {
                bestStart = data.startLine;
                bestMatch = chapterId;
            }
        }
        return bestMatch;
    }
    
    const VOL1_TOTAL_LINES = 20426;

    function getVolumeRelativeLine(absLineNum, volume) {
        volume = volume || currentVolume;
        if (volume === 2) {
            return absLineNum - VOL1_TOTAL_LINES;
        }
        return absLineNum;
    }
    
    function getChapterFromLine(absLineNum, volume) {
        volume = volume || currentVolume;
        const chapterKey = findChapterFromLine(absLineNum, volume);
        const chapterData = CHAPTER_MAP[chapterKey];
        return chapterData ? chapterData.chapter : null;
    }

        let currentLayer = null;
        let currentLine = null;
        let currentVolume = 1;
        let selectedTranslationLayer = null;
        
        function setCurrentVolumeFromChapterKey(key) {
            currentVolume = key.startsWith('02-') ? 2 : 1;
        }
        const welcomeScreen = document.getElementById('welcome');
        const lineIndicator = document.getElementById('line-indicator');
        const navTabs = document.querySelectorAll('.nav-tab');
        const consentModal = document.getElementById('consent-modal');
        const consentImage1 = document.getElementById('consent-image-1');
        const consentImage2 = document.getElementById('consent-image-2');

        document.querySelectorAll('.layer-frame').forEach(iframe => { iframe.src = 'about:blank'; });

        // Check if user has already consented to all steps
        if (localStorage.getItem('consentAccepted') === 'true' &&
            localStorage.getItem('imageConsent1Accepted') === 'true' &&
            localStorage.getItem('imageConsent2Accepted') === 'true') {
            consentModal.classList.add('hidden');
            consentImage1.classList.add('hidden');
            consentImage2.classList.add('hidden');
        } else if (localStorage.getItem('consentAccepted') === 'true' &&
                   localStorage.getItem('imageConsent1Accepted') === 'true') {
            consentModal.classList.add('hidden');
            consentImage1.classList.add('hidden');
            consentImage2.classList.remove('hidden');
        } else if (localStorage.getItem('consentAccepted') === 'true') {
            consentModal.classList.add('hidden');
            consentImage1.classList.remove('hidden');
        }

        function acceptConsent() {
            localStorage.setItem('consentAccepted', 'true');
            consentModal.classList.add('hidden');
            consentImage1.classList.remove('hidden');
        }

        function acceptImageConsent1() {
            localStorage.setItem('imageConsent1Accepted', 'true');
            consentImage1.classList.add('hidden');
            consentImage2.classList.remove('hidden');
        }

        function acceptImageConsent2() {
            localStorage.setItem('imageConsent2Accepted', 'true');
            consentImage2.classList.add('hidden');
        }

        // Restore selected translation layer from localStorage
        selectedTranslationLayer = localStorage.getItem('selectedLayer') || 'tibetan';

    function handleLayerSelect(value) {
        if (!value) return;
        
        const targetLayer = value.slice(1); // Remove #
        
        // If on conventions page, reload iframe with new layer param
        if (currentLayer === 'conventions') {
            const iframe = document.querySelector('#conventions-frame');
            if (iframe) {
                let effectiveLayer = targetLayer;
                if (effectiveLayer === 'introduction') effectiveLayer = 'liturgical';
                iframe.src = iframe.dataset.src + '?layer=' + effectiveLayer;
            }
            return;
        }
        
        // If already on a translation layer, preserve line/volume
        if (currentLayer && currentLine && layers[targetLayer] && layers[targetLayer].exactMatch) {
            window.location.hash = `${targetLayer}:${currentVolume}::${currentLine}`;
        } else {
            window.location.hash = value;
        }
    }

    function updateLayerDropdown(layerId) {
        const dropdown = document.getElementById('layer-select');
        if (!dropdown) return;
        
        const translationLayers = ['introduction', 'tibetan', 'wylie', 'literal', 'liturgical', 'commentary', 'scholar', 'epistemic', 'delusion', 'cognitive'];
        if (translationLayers.includes(layerId)) {
            dropdown.value = '#' + layerId;
        } else {
            // Show last selected translation layer when on contents/glossary/welcome
            const lastLayer = localStorage.getItem('selectedLayer');
            if (lastLayer && translationLayers.includes(lastLayer)) {
                dropdown.value = '#' + lastLayer;
            } else {
                dropdown.value = '#liturgical';
            }
        }
    }

    function handleNavigation() {
        const hash = window.location.hash.slice(1) || '';
        if (!hash) { showWelcome(); return; }
        const parts = hash.split(':');
        const layerId = parts[0];
        const volume = parts[1] ? parseInt(parts[1]) : null;
        const chapter = parts[2] && parts[2] !== '' ? parseInt(parts[2]) : null;
        const lineNum = parts[3] ? parseInt(parts[3]) : null;
        
        // Handle old format: #layer:line (no volume)
        if (parts.length === 2 && !isNaN(parseInt(parts[1]))) {
            // Old format: #layer:line
            if (!layers[layerId]) { showWelcome(); return; }
            currentLine = parseInt(parts[1]);
            showLayer(layerId, currentLine, currentVolume, null);
            return;
        }
        
        if (!layers[layerId]) { showWelcome(); return; }
        
        if (volume) currentVolume = volume;
        if (lineNum && !isNaN(lineNum)) currentLine = lineNum;
        showLayer(layerId, lineNum, volume, chapter);
    }

    function showWelcome() {
        welcomeScreen.style.display = 'flex';
        document.querySelectorAll('.layer-content').forEach(el => el.classList.remove('active'));
        // Keep translation layer radio selected
        navTabs.forEach(tab => {
            const href = tab.getAttribute('href');
            if (href === '#' + selectedTranslationLayer) {
                tab.classList.add('active');
            } else if (href !== '#contents' && href !== '#introduction') {
                tab.classList.remove('active');
            }
        });
        // Update dropdown to show last selected translation layer
        const lastLayer = localStorage.getItem('selectedLayer') || 'tibetan';
        updateLayerDropdown(lastLayer);
        currentLayer = null;
        hideLineIndicator();
    }

    function showLayer(layerId, targetLine, targetVolume, targetChapter) {
        welcomeScreen.style.display = 'none';
        
        if (targetVolume) currentVolume = targetVolume;
        
        // Update nav tabs
        navTabs.forEach(tab => {
            const href = tab.getAttribute('href');
            if (layerId === 'contents' || layerId === 'glossary' || layerId === 'conventions') {
                // When on contents/glossary/conventions, highlight the selected translation layer
                if (href === '#' + selectedTranslationLayer) {
                    tab.classList.add('active');
                } else if (href !== '#' + layerId) {
                    tab.classList.remove('active');
                }
            } else {
                // Normal behavior for other layers (including introduction)
                tab.classList.toggle('active', href === '#' + layerId);
                // Update selected translation layer
                if (href === '#' + layerId && layerId !== 'contents' && layerId !== 'glossary' && layerId !== 'conventions') {
                    selectedTranslationLayer = layerId;
                    localStorage.setItem('selectedLayer', layerId);
                }
            }
        });

        document.querySelectorAll('.layer-content').forEach(el => el.classList.toggle('active', el.id === layerId));

        const iframe = document.querySelector(`#${layerId} .layer-frame`);
        const lineToUse = targetLine || currentLine;

        if (iframe) {
            if (iframe.src === 'about:blank' || !iframe.src || iframe.src === 'about:blank') {
                let src = iframe.dataset.src;
                if (layerId === 'conventions') {
                    // Get current layer from dropdown, default introduction to liturgical
                    let dropdownLayer = document.getElementById('layer-select').value.replace('#', '');
                    if (dropdownLayer === 'introduction') dropdownLayer = 'liturgical';
                    src += '?layer=' + dropdownLayer;
                } else if (layerId === 'introduction') {
                    const chapterId = targetChapter 
                        ? `${String(currentVolume).padStart(2, '0')}-${String(targetChapter).padStart(2, '0')}`
                        : findChapterFromLine(lineToUse, currentVolume);
                    src += '#chapter-' + chapterId;
                } else if (lineToUse && !isNaN(lineToUse) && layers[layerId].exactMatch) {
                    src += `#line-${currentVolume}-${lineToUse}`;
                }
                iframe.src = src;
            } else if (layerId === 'conventions') {
                // Reload with new layer param when dropdown changes
                let dropdownLayer = document.getElementById('layer-select').value.replace('#', '');
                if (dropdownLayer === 'introduction') dropdownLayer = 'liturgical';
                iframe.src = iframe.dataset.src + '?layer=' + dropdownLayer;
            } else if (layerId === 'introduction') {
                const chapterId = targetChapter 
                    ? `${String(currentVolume).padStart(2, '0')}-${String(targetChapter).padStart(2, '0')}`
                    : findChapterFromLine(lineToUse, currentVolume);
                iframe.src = iframe.dataset.src + '#chapter-' + chapterId;
            } else if (lineToUse && !isNaN(lineToUse) && layers[layerId].exactMatch) {
                iframe.src = iframe.dataset.src + `#line-${currentVolume}-${lineToUse}`;
            }
        }

        currentLayer = layerId;
        
        // Update dropdown selection
        updateLayerDropdown(layerId);
    }

    function getCurrentLineFromIframe(layerId) {
        const iframe = document.querySelector(`#${layerId} .layer-frame`);
        if (!iframe || !iframe.contentDocument) {
            console.log('No iframe or contentDocument for', layerId);
            return null;
        }
        try {
            const doc = iframe.contentDocument;
            const topElement = doc.elementFromPoint(50, 100);
            console.log('Top element at (50, 100):', topElement);
            if (topElement) {
                let el = topElement;
                while (el && el !== doc.body) {
                    if (el.id && el.id.startsWith('line-')) {
                        console.log('Found line element:', el.id);
                        const lineNum = el.id.replace('line-', '');
                        // Detect volume from parent chapter
                        const chapter = el.closest('[data-chapter-key]');
                        if (chapter) {
                            setCurrentVolumeFromChapterKey(chapter.dataset.chapterKey);
                            console.log('Detected volume:', currentVolume, 'from chapter:', chapter.dataset.chapterKey);
                        }
                        return lineNum;
                    }
                    el = el.parentElement;
                }
                console.log('No line- ancestor found for top element');
            }
            // Fallback: find any line element near top of viewport
            const lines = doc.querySelectorAll('[id^="line-"]');
            console.log('Found', lines.length, 'line elements');
            const iframeRect = iframe.getBoundingClientRect();
            for (const line of lines) {
                const lineRect = line.getBoundingClientRect();
                if (lineRect.top >= iframeRect.top && lineRect.top <= iframeRect.top + 200) {
                    console.log('Fallback found line:', line.id);
                    const lineNum = line.id.replace('line-', '');
                    // Detect volume from parent chapter
                    const chapter = line.closest('[data-chapter-key]');
                    if (chapter) {
                        setCurrentVolumeFromChapterKey(chapter.dataset.chapterKey);
                        console.log('Detected volume:', currentVolume, 'from chapter:', chapter.dataset.chapterKey);
                    }
                    return lineNum;
                }
            }
            console.log('No line found in viewport');
            return null;
        } catch (e) {
            console.log('Error getting line from iframe:', e);
            return null;
        }
    }

    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            const targetLayer = this.getAttribute('href').slice(1);
            
            // If clicking contents/glossary/conventions, keep the line from current translation layer
            if ((targetLayer === 'contents' || targetLayer === 'glossary' || targetLayer === 'conventions' || targetLayer === 'introduction') && currentLayer && layers[currentLayer] && layers[currentLayer].exactMatch) {
                const line = getCurrentLineFromIframe(currentLayer);
                if (line) {
                    currentLine = parseInt(line);
                    console.log('Captured line from', currentLayer, ':', currentLine);
                }
                return; // Let normal navigation proceed
            }
            // If clicking a translation layer from contents/glossary/conventions/introduction, navigate with current line
            else if ((currentLayer === 'contents' || currentLayer === 'glossary' || currentLayer === 'conventions' || currentLayer === 'introduction') && targetLayer !== 'contents' && targetLayer !== 'glossary' && targetLayer !== 'conventions' && targetLayer !== 'introduction' && layers[targetLayer] && layers[targetLayer].exactMatch && currentLine) {
                e.preventDefault();
                window.location.hash = `${targetLayer}:${currentVolume}::${currentLine}`;
                console.log('Navigating from', currentLayer, 'to', targetLayer, 'with volume', currentVolume, 'line', currentLine);
            }
            // If switching between translation layers, preserve line
            else if (currentLayer && targetLayer !== 'contents' && targetLayer !== 'glossary' && targetLayer !== 'conventions' && targetLayer !== 'introduction' && currentLayer !== 'contents' && currentLayer !== 'glossary' && currentLayer !== 'conventions' && currentLayer !== 'introduction' && layers[targetLayer] && layers[targetLayer].exactMatch) {
                const line = getCurrentLineFromIframe(currentLayer);
                console.log('Switching from', currentLayer, 'to', targetLayer, '- detected line:', line, 'currentLine:', currentLine);
                e.preventDefault();
                if (line) {
                    currentLine = parseInt(line);
                    window.location.hash = `${targetLayer}:${currentVolume}::${currentLine}`;
                } else if (currentLine) {
                    window.location.hash = `${targetLayer}:${currentVolume}::${currentLine}`;
                } else {
                    window.location.hash = targetLayer;
                }
            }
        });
    });

    // Listen for messages from contents iframe
    window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'navigateToLine') {
            const lineNum = e.data.line;
            let vol = e.data.volume ? parseInt(e.data.volume) : (currentVolume || 1);
            if (lineNum) {
                currentLine = parseInt(lineNum);
                currentVolume = vol;
                currentVolume = vol;
                window.location.hash = `${selectedTranslationLayer}:${vol}::${lineNum}`;
            }
        }
        // Listen for line position updates from translation layers
        if (e.data && e.data.type === 'linePosition') {
            const lineNum = parseInt(e.data.line);
            if (!isNaN(lineNum)) {
                currentLine = lineNum;
                if (e.data.volume) {
                    currentVolume = parseInt(e.data.volume);
                }
                console.log('Updated currentLine from iframe:', currentLine, 'volume:', currentVolume);
            }
        }
        // Listen for chapter position updates from introduction iframe
        if (e.data && e.data.type === 'chapterPosition') {
            const lineNum = parseInt(e.data.line);
            const vol = parseInt(e.data.volume) || 1;
            if (!isNaN(lineNum)) {
                currentLine = lineNum;
                currentVolume = vol;
                console.log('Updated from introduction chapter:', currentLine, 'volume:', currentVolume);
            }
        }
    });

    function showLineIndicator(layer, line, type) {
        const names = {
            introduction: 'Introduction',
            tibetan: 'Tibetan',
            glossary: 'Glossary',
            wylie: 'Wylie',
            literal: 'Literal',
            liturgical: 'Liturgical',
            commentary: 'Commentary',
            scholar: 'Scholar',
            epistemic: 'Epistemic',
            delusion: 'Delusion',
            cognitive: 'Cognitive',
            contents: 'Contents'
        };
        lineIndicator.textContent = `${names[layer] || layer}: Line ${line}${type==='range'?' (nearest range)':''}`;
        lineIndicator.classList.add('visible');
        setTimeout(() => lineIndicator.classList.remove('visible'), 3000);
    }

    function hideLineIndicator() { lineIndicator.classList.remove('visible'); }

    window.addEventListener('hashchange', handleNavigation);

    document.querySelectorAll('.layer-frame').forEach(iframe => {
        iframe.addEventListener('load', function() {
            if (!currentLayer) return;
            try {
                const doc = this.contentDocument;
                if (currentLayer === 'tibetan' || currentLayer === 'wylie') {
                    doc.querySelectorAll('[class*="line-num"]').forEach(el => {
                        const t = el.textContent.trim();
                        if (t && /^\d+$/.test(t)) el.id = 'line-' + t;
                    });
                }
                if (currentLine && layers[currentLayer] && layers[currentLayer].exactMatch) {
                    showLineIndicator(currentLayer, currentLine, 'exact');
                }
            } catch (e) {}
        });
    });

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const btn = document.querySelector('.dark-mode-toggle');
        btn.textContent = document.body.classList.contains('dark-mode') ? 'Light' : 'Dark';
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        // Notify same-origin iframes
        document.querySelectorAll('.layer-frame').forEach(iframe => {
            try {
                console.log('Sending darkModeChange to:', iframe.dataset.src, 'enabled:', document.body.classList.contains('dark-mode'));
                iframe.contentWindow.postMessage({
                    type: 'darkModeChange',
                    enabled: document.body.classList.contains('dark-mode')
                }, '*');
            } catch (e) {
                console.log('Error sending to iframe:', iframe.dataset.src, e);
            }
        });
    }

    if (localStorage.getItem('darkMode') === 'false') {
        document.body.classList.remove('dark-mode');
        document.querySelector('.dark-mode-toggle').textContent = 'Dark';
    } else {
        document.body.classList.add('dark-mode');
        document.querySelector('.dark-mode-toggle').textContent = 'Light';
    }

    handleNavigation();
    </script>
</body>

</html>
